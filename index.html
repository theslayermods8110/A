<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APK Insight - Núcleo Estable</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
    <!-- Dependencias Externas -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <!-- JSZip Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* === CSS ORIGINAL DEL PANEL Y ANALIZADOR (SIN CAMBIOS) === */
        :root{--primary-purple:#9333ea;--light-purple-hover:#a855f7;--bright-purple:#c084fc;--dark-bg:#050508;--panel-bg-glass:rgba(16,16,24,.92);--content-bg-fallback:#0d0d12;--text-color:#f8f8fc;--text-secondary:#b0b0c0;--border-color:rgba(147,51,234,.3);--border-hover-color:rgba(192,132,252,.9);--border-active-color:var(--bright-purple);--active-bg:rgba(168,85,247,.2);--error-color:#f87171;--success-color:#4ade80;--border-radius-sml:10px;--border-radius-med:15px;--box-shadow-color:rgba(147,51,234,.1);--box-shadow-hover-color:rgba(192,132,252,.35);--box-shadow-inset:rgba(0,0,0,.4);--glow-color:rgba(168,85,247,.5);--glow-active:rgba(192,132,252,.75);--panel-width:275px;--extreme-duration-fast:.4s;--extreme-duration-med:.6s;--extreme-duration-slow:.75s;--extreme-duration-content:.7s;--elastic-bounce-bezier:cubic-bezier(.68,-.6,.32,1.6);--liquid-overshoot-bezier:cubic-bezier(.5,1.6,.5,1);--anticipate-bezier:cubic-bezier(.4,-.5,.6,1);--dampened-spring-bezier:cubic-bezier(.2,1.2,.4,1);--smooth-out-bezier:cubic-bezier(.25,.8,.25,1)}@keyframes buttonInflateWobble{0%{transform:scale(1) translateY(0);filter:brightness(1)}30%{transform:scale(1.08,1.05) translateY(-4px);filter:brightness(1.15)}60%{transform:scale(.98,1.02) translateY(-1px);filter:brightness(1.05)}100%{transform:scale(1.03,1.01) translateY(-2px);filter:brightness(1.1)}}@keyframes cogWobbleSpin{0%{transform:rotate(0deg) scale(1);text-shadow:0 0 6px var(--primary-purple),0 0 12px var(--primary-purple)}25%{transform:rotate(60deg) scale(1.1)}50%{transform:rotate(120deg) scale(.95);text-shadow:0 0 10px var(--light-purple-hover),0 0 20px var(--light-purple-hover),0 0 5px #fff}75%{transform:rotate(160deg) scale(1.05)}100%{transform:rotate(180deg) scale(1);text-shadow:0 0 8px var(--primary-purple),0 0 16px var(--primary-purple)}}@keyframes cogWobbleSpinBack{0%{transform:rotate(180deg) scale(1);text-shadow:0 0 10px var(--light-purple-hover),0 0 20px var(--light-purple-hover),0 0 5px #fff}25%{transform:rotate(120deg) scale(1.1)}50%{transform:rotate(60deg) scale(.95);text-shadow:0 0 6px var(--primary-purple),0 0 12px var(--primary-purple)}75%{transform:rotate(20deg) scale(1.05)}100%{transform:rotate(0deg) scale(1);text-shadow:0 0 6px var(--primary-purple),0 0 12px var(--primary-purple)}}@keyframes iconBoing{0%{transform:scale3d(1,1,1)}30%{transform:scale3d(1.35,.75,1)}40%{transform:scale3d(.75,1.35,1)}50%{transform:scale3d(1.25,.85,1)}65%{transform:scale3d(.9,1.2,1)}80%{transform:scale3d(1.1,.95,1)}100%{transform:scale3d(1.1,1,1)}}@keyframes textGlowPulse{0%,100%{text-shadow:0 0 2px rgba(248,248,252,.5)}50%{text-shadow:0 0 8px #f8f8fc,0 0 4px var(--bright-purple)}}@keyframes shuttleWarpDrive{0%{transform:translateY(0) scale(1) rotate(-1deg);opacity:.9;filter:blur(0)}48%{transform:translateY(-10px) scale(1.05) rotate(1deg);opacity:1;filter:blur(0)}50%{transform:translateY(-10px) scale(1.5,.5) rotate(1deg);opacity:.5;filter:blur(3px)}52%{transform:translateY(0) scale(1) rotate(-1deg);opacity:.9;filter:blur(0)}100%{transform:translateY(0) scale(1) rotate(-1deg);opacity:.9;filter:blur(0)}}@keyframes pointerPulseGlow{0%,100%{transform:scale(1);opacity:.6;filter:drop-shadow(0 0 4px var(--glow-color))}50%{transform:scale(1.2);opacity:1;filter:drop-shadow(0 0 10px var(--bright-purple))}}@keyframes spinnerStretch{0%,100%{transform:rotate(0deg) scale(1)}50%{transform:rotate(180deg) scale(1.2,.8)}}@keyframes backgroundPulseShift{0%{background-position:0 50%;filter:saturate(1)}50%{background-position:100% 80%;filter:saturate(1.1) brightness(1.05)}100%{background-position:0 50%;filter:saturate(1)}}@keyframes subtleShine{0%{transform:translateX(-100%) skewX(-20deg);opacity:.1}100%{transform:translateX(100%) skewX(-20deg);opacity:0}}
        *{margin:0;padding:0;box-sizing:border-box}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:10px}::-webkit-scrollbar-thumb{background-color:var(--primary-purple);border-radius:10px;border:2px solid transparent;background-clip:content-box}::-webkit-scrollbar-thumb:hover{background-color:var(--light-purple-hover)}
        html{height:100%;scroll-behavior:smooth}body{font-family:'Roboto',sans-serif;background:linear-gradient(140deg,#0f101a,#151528,#050508,#100a15);background-size:200% 200%;animation:backgroundPulseShift 18s ease-in-out infinite;color:var(--text-color);min-height:100vh;line-height:1.65;overflow:hidden;position:relative;display:flex;flex-direction:column;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        .contenedor-principal{flex-grow:1;display:flex;position:relative;min-height:100vh;overflow:hidden}
        #menu-toggle{position:fixed;top:18px;left:18px;z-index:1001;background:linear-gradient(145deg,var(--primary-purple),var(--light-purple-hover));color:#fff;border:none;padding:13px 15px;font-size:1.45em;border-radius:var(--border-radius-sml);cursor:pointer;box-shadow:0 6px 15px rgba(0,0,0,.45),0 0 10px var(--glow-color);transition:transform var(--extreme-duration-med) var(--elastic-bounce-bezier),box-shadow var(--extreme-duration-med) var(--dampened-spring-bezier),background var(--extreme-duration-med) var(--dampened-spring-bezier);will-change:transform,box-shadow}#menu-toggle:hover{transform:scale(1.2) translateY(-2px);box-shadow:0 10px 25px rgba(192,132,252,.45),0 0 22px var(--glow-active)}#menu-toggle i.fa-cog{display:block;color:#fff;text-shadow:0 0 6px var(--primary-purple),0 0 12px var(--primary-purple);transition:text-shadow var(--extreme-duration-fast) ease;animation:cogWobbleSpinBack .8s var(--dampened-spring-bezier) forwards;will-change:transform,text-shadow}#menu-toggle.icon-rotated i.fa-cog{animation:cogWobbleSpin .9s var(--elastic-bounce-bezier) forwards}#menu-toggle:focus-visible{outline:3px solid var(--bright-purple);outline-offset:3px}#menu-toggle:active{transform:scale(.9);transition:transform .15s var(--anticipate-bezier);box-shadow:0 2px 5px rgba(0,0,0,.3),0 0 4px var(--glow-color)}
        #panel-navegacion{position:fixed;top:0;left:0;bottom:0;width:var(--panel-width);background:var(--panel-bg-glass);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);border-right:1px solid var(--border-color);box-shadow:8px 0 35px rgba(0,0,0,.4),4px 0 20px var(--box-shadow-color);display:flex;flex-direction:column;padding-top:0;padding-bottom:0;overflow:hidden;z-index:1000;transform:translateX(-100%);transition:transform var(--extreme-duration-slow) var(--dampened-spring-bezier);will-change:transform}#panel-navegacion.panel-visible{transform:translateX(0)}.contenedor-principal.panel-is-interacting #area-contenido{transform:scale(.98) translateX(15px);filter:brightness(.95)}.contenedor-principal.panel-is-open #area-contenido{transform:scale(.97) translateX(30px);filter:brightness(.9);border-radius:20px}
        .panel-scroll-content{flex-grow:1;overflow-y:auto;padding:85px 25px 35px;scrollbar-width:thin;scrollbar-color:var(--primary-purple) transparent}
        .panel-content-wrapper{display:flex;flex-direction:column;min-height:100%}
        #panel-navegacion .panel-scroll-content .boton-panel,#panel-navegacion .panel-scroll-content .panel-separator,#panel-navegacion .panel-scroll-content #boton-limpiar-area{opacity:0;transform:translateY(30px) scale(.95) skewY(2deg)}#panel-navegacion.panel-visible .panel-scroll-content .boton-panel,#panel-navegacion.panel-visible .panel-scroll-content .panel-separator,#panel-navegacion.panel-visible .panel-scroll-content #boton-limpiar-area{opacity:1;transform:translateY(0) scale(1) skewY(0deg);transition:opacity var(--extreme-duration-med) var(--elastic-bounce-bezier),transform var(--extreme-duration-slow) var(--elastic-bounce-bezier);will-change:opacity,transform}#panel-navegacion.panel-visible .panel-content-wrapper>.boton-panel:nth-of-type(1){transition-delay:.08s}#panel-navegacion.panel-visible .panel-content-wrapper>.boton-panel:nth-of-type(2){transition-delay:.13s}#panel-navegacion.panel-visible .panel-separator{transition-delay:.18s}#panel-navegacion.panel-visible #boton-limpiar-area{transition-delay:.22s}
        .boton-panel{display:flex;align-items:center;gap:16px;width:100%;padding:15px 18px;margin-bottom:18px;background-color:transparent;border:1px solid var(--border-color);color:var(--text-secondary);font-size:1.1em;font-weight:400;text-align:left;border-radius:var(--border-radius-sml);cursor:pointer;text-decoration:none;transition:color var(--extreme-duration-fast) ease,border-color var(--extreme-duration-fast) ease,transform var(--extreme-duration-fast) var(--elastic-bounce-bezier),box-shadow var(--extreme-duration-fast) ease;will-change:color,border-color,transform,box-shadow;position:relative;overflow:hidden;transform:scale(1);z-index:1}.boton-panel::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(45deg,var(--primary-purple),var(--light-purple-hover));opacity:0;transform:scaleY(0);transform-origin:bottom;transition:transform var(--extreme-duration-med) var(--liquid-overshoot-bezier),opacity var(--extreme-duration-fast) ease;will-change:transform,opacity;z-index:-1;border-radius:inherit}.boton-panel::after{content:'';position:absolute;top:0;left:0;width:150%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);transform:translateX(-100%) skewX(-20deg);opacity:0;transition:transform 0s,opacity 0s;z-index:0}.boton-panel:hover::after{animation:subtleShine 1s cubic-bezier(.4,0,.2,1) forwards;transition:none}.boton-panel:hover::before{transform:scaleY(1);opacity:.18}.boton-panel.active::before{transform:scaleY(1);opacity:.22;transition-duration:var(--extreme-duration-fast)}.boton-panel i{flex-shrink:0;width:24px;text-align:center;color:var(--primary-purple);font-size:1.25em;transition:color var(--extreme-duration-fast) ease,transform var(--extreme-duration-med) var(--elastic-bounce-bezier);will-change:color,transform;z-index:1}.boton-panel span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:color var(--extreme-duration-fast) ease;z-index:1}.boton-panel:hover{border-color:var(--border-hover-color);color:var(--text-color);animation:buttonInflateWobble .6s var(--dampened-spring-bezier) forwards}.boton-panel:not(:hover){animation:none;transition:transform .2s ease-out,filter .2s ease-out}.boton-panel:hover i{color:var(--bright-purple);animation:iconBoing .5s var(--elastic-bounce-bezier) forwards}.boton-panel:hover span{animation:textGlowPulse 1.3s ease-in-out infinite}.boton-panel:focus-visible{outline:3px solid var(--border-hover-color);outline-offset:2px;border-color:var(--border-hover-color);color:var(--text-color)}.boton-panel:active{transform:scale(.92)!important;transition:transform .1s var(--anticipate-bezier)!important;filter:brightness(.9)!important;animation:none!important}.boton-panel:active i,.boton-panel:active span{animation:none!important}.boton-panel.active{border-color:var(--border-active-color);color:var(--text-color);box-shadow:0 0 15px var(--glow-active),inset 0 0 10px rgba(192,132,252,.25);transform:scale(1.01);animation:none}.boton-panel.active i{color:var(--bright-purple);transform:scale(1.1);animation:none}.boton-panel.active:hover{cursor:default;border-color:var(--border-active-color);animation:none}.boton-panel.youtube-link i.fa-youtube{color:#f11}.boton-panel.youtube-link:hover{border-color:#f66}.boton-panel.youtube-link:hover i.fa-youtube{color:#f55}.boton-panel.youtube-link::before{background:linear-gradient(45deg,#f33,#f66)}
        .panel-separator{height:1px;background:linear-gradient(90deg,transparent,rgba(168,85,247,.4),transparent);margin:15px 0 35px;border:none}#panel-navegacion.panel-visible .panel-separator{background:linear-gradient(90deg,transparent,rgba(192,132,252,.7),transparent)}
        #boton-limpiar-area{margin-top:auto;padding-top:30px;padding-bottom:10px}#boton-limpiar{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:15px 17px;background-color:rgba(60,60,80,.7);border:1px solid var(--text-secondary);color:var(--text-secondary);font-size:1.08em;border-radius:var(--border-radius-sml);cursor:pointer;position:relative;z-index:1;overflow:hidden;transition:color var(--extreme-duration-fast) ease,border-color var(--extreme-duration-fast) ease,transform var(--extreme-duration-fast) var(--elastic-bounce-bezier),box-shadow var(--extreme-duration-fast) ease;will-change:color,border-color,transform,box-shadow}#boton-limpiar::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(45deg,#666,#bbb);opacity:0;transform:scaleY(0);transform-origin:bottom;transition:transform var(--extreme-duration-med) var(--liquid-overshoot-bezier),opacity var(--extreme-duration-fast) ease;will-change:transform,opacity;z-index:-1;border-radius:inherit}#boton-limpiar::after{content:'';position:absolute;top:0;left:0;width:150%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%) skewX(-20deg);opacity:0;transition:transform 0s,opacity 0s;z-index:0}#boton-limpiar:hover::after{animation:subtleShine 1.2s cubic-bezier(.4,0,.2,1) forwards;transition:none}#boton-limpiar:hover::before{transform:scaleY(1);opacity:.18}#boton-limpiar i{flex-shrink:0;color:var(--text-secondary);transition:color var(--extreme-duration-fast) ease,transform var(--extreme-duration-med) var(--elastic-bounce-bezier);will-change:color,transform;z-index:1}#boton-limpiar span{z-index:1;transition:color var(--extreme-duration-fast) ease}#boton-limpiar:hover{border-color:var(--text-color);color:var(--text-color);animation:buttonInflateWobble .6s var(--dampened-spring-bezier) forwards}#boton-limpiar:not(:hover){animation:none;transition:transform .2s ease-out,filter .2s ease-out}#boton-limpiar:hover i{color:var(--text-color);animation:iconBoing .5s var(--elastic-bounce-bezier) forwards}#boton-limpiar:focus-visible{outline:3px solid var(--text-color);outline-offset:2px}#boton-limpiar:active{transform:scale(.92)!important;transition:transform .1s var(--anticipate-bezier)!important;filter:brightness(.9)!important;animation:none!important}#boton-limpiar:active i,#boton-limpiar:active span{animation:none!important}
        #area-contenido{flex-grow:1;width:100%;min-height:100vh;overflow:hidden;display:flex;flex-direction:column;position:relative;padding:30px;perspective:1500px;transition:transform var(--extreme-duration-slow) var(--dampened-spring-bezier),filter var(--extreme-duration-slow) var(--dampened-spring-bezier),border-radius var(--extreme-duration-slow) var(--dampened-spring-bezier);will-change:transform,filter,border-radius;border-radius:0;background:var(--content-bg-fallback)}#area-contenido.allow-scroll{overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--primary-purple) transparent}
        .loader-container{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(5,5,8,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;opacity:0;visibility:hidden;transition:opacity .5s var(--dampened-spring-bezier),visibility 0s linear .5s;pointer-events:none;border-radius:inherit}.loader-container.visible{opacity:1;visibility:visible;transition-delay:.1s,.1s;pointer-events:auto}
        .spinner{width:55px;height:55px;border:none;border-radius:50%;background:conic-gradient(from 0deg,transparent 0% 50%,var(--bright-purple) 90% 100%);animation:spinnerStretch .8s linear infinite}
        #progressInfo{color:var(--text-secondary);margin-top:20px;font-size:.95em;text-shadow:1px 1px 2px rgba(0,0,0,.5);width:90%;text-align:center}
        .input-area-pro{padding:25px;margin-bottom:2rem;text-align:center;border:1px dashed var(--border-color);border-radius:var(--border-radius-med);background:rgba(20,20,35,.6);box-shadow:inset 0 0 15px rgba(0,0,0,.4),0 4px 10px var(--box-shadow-color)}
        .input-area-pro label[role="button"]{background:linear-gradient(145deg,var(--primary-purple),var(--light-purple-hover));color:#fff;border:none;padding:12px 25px;font-size:1.1em;border-radius:var(--border-radius-sml);cursor:pointer;display:inline-block;margin-bottom:15px;box-shadow:0 5px 12px rgba(0,0,0,.3),0 0 8px var(--glow-color);transition:transform .2s var(--elastic-bounce-bezier),box-shadow .2s ease}
        .input-area-pro label[role="button"]:hover{transform:scale(1.05) translateY(-2px);box-shadow:0 8px 18px rgba(192,132,252,.35),0 0 15px var(--glow-active)}
        .input-area-pro label[role="button"]:active{transform:scale(.95);box-shadow:0 2px 5px rgba(0,0,0,.2)}
        #fileNameDisplay{color:var(--text-secondary);font-style:italic;margin-top:10px;display:block;min-height:1.3em;font-size:.9em}
        .error-display{color:var(--error-color);font-weight:700;text-align:center;margin-top:15px;padding:10px;background:rgba(248,113,113,.1);border:1px solid var(--error-color);border-radius:var(--border-radius-sml);font-size:.95em}
        #resultsArea{width:100%;flex-grow:1;margin-top:1rem;position:relative;opacity:0;transform:translateY(20px);transition:opacity .6s var(--smooth-out-bezier) .1s,transform .6s var(--dampened-spring-bezier) .1s;will-change:opacity,transform}#resultsArea.visible{opacity:1;transform:translateY(0)}
        #resultsArea h2{font-family:'Orbitron',sans-serif;color:var(--bright-purple);font-size:1.6em;text-align:center;margin-bottom:1.5rem;padding-bottom:.8rem;border-bottom:2px solid var(--primary-purple);text-shadow:0 0 8px var(--glow-color)}
        .results-placeholder{/*position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);*/ /* Removed absolute positioning */ margin-top: 3rem; /* Added margin */ color:var(--text-secondary);text-align:center;padding:2rem;font-style:italic;font-size:1.1em;display:flex;flex-direction:column;align-items:center;gap:15px}.results-placeholder i{font-size:2.5em;color:var(--primary-purple);opacity:.6}
        #resultsContainer{display:flex;flex-direction:column;gap:1.8rem;padding:5px}
        .findings-section{padding:1.2rem 1.5rem;border:1px solid var(--border-color);border-left:5px solid var(--primary-purple);border-radius:var(--border-radius-med);background:rgba(25,25,40,.7);box-shadow:0 5px 15px rgba(0,0,0,.25),inset 0 0 10px rgba(0,0,0,.3);transition:box-shadow .3s ease}.findings-section:hover{box-shadow:0 8px 25px rgba(0,0,0,.3),inset 0 0 15px rgba(0,0,0,.4),0 0 10px var(--glow-color)}
        .findings-section .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:.6rem;border-bottom:1px solid var(--border-color)}
        .findings-section h3{margin:0;color:var(--bright-purple);font-size:1.25em;display:flex;align-items:center;gap:12px;font-family:'Orbitron',sans-serif;text-shadow:0 0 5px var(--glow-color)}
        .findings-section h3 span.count{font-family:'Roboto',sans-serif;font-size:.75em;padding:4px 8px;background-color:rgba(147,51,234,.3);color:var(--text-color);border-radius:6px;font-weight:700;line-height:1;white-space:nowrap;border:1px solid var(--border-color)}
        .copy-section-btn{padding:.4rem .8rem;font-size:.85em;margin-left:auto;background-color:transparent;border:1px solid var(--text-secondary);color:var(--text-secondary);border-radius:var(--border-radius-sml);cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:6px}.copy-section-btn:hover{border-color:var(--bright-purple);color:var(--bright-purple);background-color:rgba(192,132,252,.1)}.copy-section-btn:active{transform:scale(.95)}.copy-section-btn.copied{background-color:rgba(74,222,128,.2);color:var(--success-color);border-color:var(--success-color)}.copy-section-btn.copied i{color:var(--success-color)}.copy-section-btn i{font-size:.9em}
        .findings-section ul{list-style:none;padding-left:0;max-height:400px;overflow-y:auto;margin:0;font-family:'Roboto Mono',monospace;scrollbar-width:thin;scrollbar-color:var(--primary-purple) transparent;padding-right:8px}
        .findings-section li{margin-bottom:8px;padding:8px 5px;border-bottom:1px dashed rgba(147,51,234,.2);word-wrap:break-word;display:flex;justify-content:space-between;align-items:center;font-size:.9em;transition:background-color .2s ease}.findings-section li:last-child{border-bottom:none}.findings-section li:hover{background-color:rgba(168,85,247,.08)}
        .finding-location{flex-grow:1;margin-right:20px;color:var(--text-secondary)}
        .finding-offset{font-size:.9em;color:var(--bright-purple);white-space:nowrap;text-align:right;flex-shrink:0;font-weight:700}
        .finding-arch{font-size:.85em;color:var(--text-color);background-color:rgba(147,51,234,.4);padding:2px 6px;border-radius:4px;margin-left:10px;font-weight:700;border:1px solid var(--border-color)}
        .no-findings{color:var(--text-secondary);text-align:center;padding:20px;font-style:italic;font-size:1.1em}
        #statusFooter{text-align:center;font-size:.9em;color:var(--text-secondary);margin-top:2rem;padding-top:1rem;border-top:1px solid var(--border-color);opacity:.8}
        @media (max-width:768px){:root{--panel-width:260px}#area-contenido{padding:20px}.panel-scroll-content{padding:80px 20px 30px}.contenedor-principal.panel-is-open #area-contenido{transform:scale(.97) translateX(20px)}#resultsArea h2{font-size:1.4em}.findings-section h3{font-size:1.15em}.findings-section li{font-size:.85em}}@media (max-width:480px){#menu-toggle{top:15px;left:15px;padding:11px 13px;font-size:1.35em}#area-contenido{padding:15px}.input-area-pro{padding:20px}.input-area-pro label[role="button"]{padding:10px 20px;font-size:1em}.panel-scroll-content{padding:75px 15px 25px}#boton-limpiar{padding:12px 14px;font-size:1em}.contenedor-principal.panel-is-open #area-contenido{transform:scale(.96) translateX(15px)}#resultsArea h2{font-size:1.3em}.findings-section h3{font-size:1.1em}.findings-section li{flex-direction:column;align-items:flex-start;gap:5px}.finding-offset{text-align:left}.copy-section-btn{font-size:.8em;padding:.3rem .6rem}.findings-section ul{max-height:300px}}
    </style>
</head>
<body>
    <!-- Input de archivo oculto -->
    <input type="file" id="apkFile" accept=".apk" style="display: none;">

    <!-- Botón del menú (Panel Original) -->
    <button id="menu-toggle" title="Mostrar/Ocultar Panel" aria-label="Toggle Navigation Menu" aria-controls="panel-navegacion" aria-expanded="false">
        <i class="fas fa-cog" aria-hidden="true"></i>
    </button>

    <!-- Contenedor Principal (Panel Original) -->
    <div class="contenedor-principal" id="contenedor-principal">
        <!-- Panel de Navegación (Panel Original - botones adaptados) -->
        <nav id="panel-navegacion" role="navigation" aria-hidden="true">
            <div class="panel-scroll-content">
                <div class="panel-content-wrapper">
                    <!-- Botón para iniciar análisis -->
                    <button class="boton-panel" id="analyzeTriggerButton">
                        <i class="fas fa-bolt fa-fw" aria-hidden="true"></i>
                        <span>Analizar APK</span>
                    </button>
                    <!-- Enlace a YouTube (Panel Original) -->
                    <a href="https://youtube.com/@lobodios7341?si=Lw-TiIaQ7m7dLnyY" target="_blank" rel="noopener noreferrer" class="boton-panel youtube-link" title="Visita mi canal de YouTube">
                         <i class="fab fa-youtube fa-fw" aria-hidden="true"></i>
                         <span>LoboDios7341</span>
                    </a>
                     <!-- Separador (Panel Original) -->
                     <hr class="panel-separator">
                    <!-- Botón para limpiar -->
                    <div id="boton-limpiar-area">
                         <button id="boton-limpiar" title="Limpiar resultados y seleccionar nuevo archivo" aria-label="Clear results and select new file">
                             <i class="fas fa-eraser" aria-hidden="true"></i>
                             <span>Limpiar / Nuevo</span>
                         </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Área de Contenido Principal (Panel Original - Contenido Analizador) -->
        <main id="area-contenido" role="main">
            <!-- Loader y Progreso (Analizador) -->
            <div class="loader-container" id="loader">
                <div class="spinner"></div>
                <div id="progressInfo">Iniciando...</div>
            </div>
            <!-- Área de Input (Analizador) -->
            <div class="input-area-pro" id="inputArea">
                <label for="apkFile" role="button" class="contrast">
                    <i class="fas fa-file-arrow-up"></i> Seleccionar APK
                </label>
                <span id="fileNameDisplay">Ningún archivo seleccionado</span>
                <div id="errorDisplay" class="error-display" style="display: none;"></div>
            </div>
            <!-- Área de Resultados (Analizador) -->
            <div id="resultsArea">
                 <h2 id="resultsTitle">Resultados del Análisis</h2>
                 <div id="resultsContainer">
                    <!-- Placeholder inicial -->
                    <div class="results-placeholder" id="resultsPlaceholder">
                         <i class="fas fa-atom"></i>
                         <span>Esperando archivo APK...</span>
                     </div>
                 </div>
                 <div id="statusFooter"></div>
            </div>
        </main>
    </div>

    <!-- === SCRIPT 1: CONTROLADOR ORIGINAL DEL PANEL (SIN CAMBIOS FUNCIONALES) === -->
    <script>
        const panelController = (() => {
            // --- Variables (Closure scope) ---
            let menuToggle, panelNavegacion, contenedorPrincipal, contentArea;
            let isPanelActionInProgress = false;
            let panelTransitionTimeout, interactionTimeout;

            // --- Funciones Internas ---
            function setInteractingClass(isInteracting) {
                if (!contenedorPrincipal) return; // Safety check
                clearTimeout(interactionTimeout);
                if (isInteracting) {
                    contenedorPrincipal.classList.add('panel-is-interacting');
                } else {
                    // Delay removing the class slightly
                    interactionTimeout = setTimeout(() => {
                        contenedorPrincipal.classList.remove('panel-is-interacting');
                    }, 150);
                }
            }

            function handlePanelTransitionEnd() {
                isPanelActionInProgress = false;
                clearTimeout(panelTransitionTimeout); // Clear any existing timeout
                setInteractingClass(false); // Remove interaction class after transition
                if (panelNavegacion?.classList.contains('panel-visible')) {
                    contenedorPrincipal?.classList.add('panel-is-open');
                } else {
                    contenedorPrincipal?.classList.remove('panel-is-open');
                }
            }

            function setupTransitionEndFallback(element, callback, durationVar) {
                if (!element) return null; // Safety check
                let ended = false;
                // Read the duration from CSS variable, provide a default
                const durationCSS = getComputedStyle(document.documentElement).getPropertyValue(durationVar);
                const durationMs = (parseFloat(durationCSS) * 1000 || 750) + 200; // Add buffer

                const onEnd = (event) => {
                    // Ensure the event is for the correct property and element, and hasn't already ended
                    if (event.target === element && event.propertyName === 'transform' && !ended) {
                        ended = true;
                        element.removeEventListener('transitionend', onEnd); // Clean up listener
                        clearTimeout(fallbackTimeout); // Clear the fallback timeout
                        if (callback) callback(); // Execute the callback
                    }
                };
                element.addEventListener('transitionend', onEnd);

                // Fallback timeout in case transitionend event doesn't fire (e.g., interrupted transition)
                const fallbackTimeout = setTimeout(() => {
                    if (!ended) {
                        // console.warn(`TransitionEnd fallback triggered for: ${element.id || element.className}`);
                        ended = true;
                        element.removeEventListener('transitionend', onEnd); // Clean up listener
                        if (callback) callback(); // Execute the callback
                    }
                }, durationMs);
                return fallbackTimeout; // Return timeout ID if needed elsewhere
            }

            function mostrarPanel() {
                // Prevent action if already in progress or panel is already visible
                if (!panelNavegacion || !menuToggle || isPanelActionInProgress || panelNavegacion.classList.contains('panel-visible')) return;

                isPanelActionInProgress = true;
                setInteractingClass(true);
                contenedorPrincipal?.classList.remove('panel-is-open'); // Remove open state immediately

                // Use requestAnimationFrame for smoother visual updates
                requestAnimationFrame(() => {
                    panelNavegacion.classList.add('panel-visible');
                    panelNavegacion.setAttribute('aria-hidden', 'false');
                    menuToggle.classList.add('icon-rotated');
                    menuToggle.setAttribute('aria-expanded', 'true');
                });

                // Setup transition end handling (with fallback)
                panelTransitionTimeout = setupTransitionEndFallback(panelNavegacion, handlePanelTransitionEnd, '--extreme-duration-slow');
            }

            function ocultarPanel() {
                // Prevent action if already in progress or panel is already hidden
                if (!panelNavegacion || !menuToggle || isPanelActionInProgress || !panelNavegacion.classList.contains('panel-visible')) return;

                isPanelActionInProgress = true;
                setInteractingClass(true);
                contenedorPrincipal?.classList.remove('panel-is-open'); // Remove open state immediately

                 // Use requestAnimationFrame for smoother visual updates
                 requestAnimationFrame(() => {
                    panelNavegacion.classList.remove('panel-visible');
                    panelNavegacion.setAttribute('aria-hidden', 'true');
                    menuToggle.classList.remove('icon-rotated');
                    menuToggle.setAttribute('aria-expanded', 'false');
                 });

                // Setup transition end handling (with fallback)
                panelTransitionTimeout = setupTransitionEndFallback(panelNavegacion, handlePanelTransitionEnd, '--extreme-duration-slow');
            }

            // --- Función Pública de Inicialización ---
            function init() {
                // Cache DOM elements used by the panel controller
                menuToggle = document.getElementById('menu-toggle');
                panelNavegacion = document.getElementById('panel-navegacion');
                contenedorPrincipal = document.getElementById('contenedor-principal');
                contentArea = document.getElementById('area-contenido'); // Also needed for initial setup

                // Critical check: ensure elements exist before adding listeners
                if (!menuToggle || !panelNavegacion || !contenedorPrincipal || !contentArea) {
                    console.error("Error fatal: Elementos clave del panel UI no encontrados en el DOM.");
                    // Consider disabling the toggle button if elements are missing
                    if(menuToggle) menuToggle.disabled = true;
                    return; // Stop initialization if core elements are missing
                }

                // Add main toggle listener
                menuToggle.addEventListener('click', () => {
                    // Simple toggle logic based on current visibility class
                    if (panelNavegacion.classList.contains('panel-visible')) {
                        ocultarPanel();
                    } else {
                        mostrarPanel();
                    }
                });

                // Set initial visual state (panel hidden, no interaction classes)
                // Use rAF to ensure styles are applied after initial render, then reset transitions
                requestAnimationFrame(() => {
                    // Force initial hidden state without transition
                    panelNavegacion.style.transition = 'none';
                    panelNavegacion.style.transform = 'translateX(-100%)';
                    panelNavegacion.setAttribute('aria-hidden', 'true');
                    menuToggle.classList.remove('icon-rotated'); // Ensure icon is correct initially
                    menuToggle.setAttribute('aria-expanded', 'false');

                    // Reset content area styles that might be affected by panel opening
                    contentArea.style.transition = 'none';
                    contentArea.style.transform = '';
                    contentArea.style.filter = '';
                    contentArea.style.borderRadius = '';

                    // Remove interaction/open classes
                    contenedorPrincipal.classList.remove('panel-is-interacting', 'panel-is-open');

                    // Also hide analyzer results initially without transition
                    const resultsArea = document.getElementById('resultsArea');
                    if(resultsArea) {
                        resultsArea.style.transition = 'none';
                        resultsArea.style.opacity = '0';
                        resultsArea.style.transform = 'translateY(20px)';
                        resultsArea.classList.remove('visible'); // Ensure class is also removed
                    }

                    // Use a tiny timeout to allow the browser to apply the 'none' transition styles,
                    // then re-enable transitions for future interactions.
                    setTimeout(() => {
                        panelNavegacion.style.transition = ''; // Re-enable CSS transitions
                        contentArea.style.transition = '';
                        if(resultsArea) resultsArea.style.transition = '';
                    }, 50); // 50ms is usually enough
                });
            }

            // Expose only necessary functions to the outside world
            // In this case, 'ocultarPanel' might be useful if other scripts need to close it.
            return {
                init: init,
                ocultarPanel: ocultarPanel
            };

        })(); // Execute the IIFE to create the controller
    </script>

    <!-- === SCRIPT 2: ANALIZADOR APK (NUEVO, SIMPLE Y AISLADO) === -->
    <script>
        const apkAnalyzer = (() => {
            // --- DOM Cache (Short names for brevity) ---
            const D = {
                loader: document.getElementById('loader'),
                prog: document.getElementById('progressInfo'),
                fileIn: document.getElementById('apkFile'),
                inArea: document.getElementById('inputArea'),
                fName: document.getElementById('fileNameDisplay'),
                err: document.getElementById('errorDisplay'),
                resArea: document.getElementById('resultsArea'),
                resCont: document.getElementById('resultsContainer'),
                foot: document.getElementById('statusFooter'),
                // Buttons are needed for enable/disable state
                analyzeBtn: document.getElementById('analyzeTriggerButton'),
                cleanBtn: document.getElementById('boton-limpiar'),
                contArea: document.getElementById('area-contenido')
            };

            // --- Constants ---
            const MAX_CONCURRENT = 10; // Concurrent file reads
            const RENDER_BATCH = 200;   // How many items to render before yielding
            const COPY_DELAY = 1500;   // ms for "Copied!" feedback
            const MIN_SIZE = 5120;     // 5KB minimum sensible APK size

            // --- Patterns (Minimal, Key Info Focus) ---
            const ELF_ARCH = { 0x28:'ARMv7', 0xB7:'ARM64', 0x03:'x86', 0x3E:'x86-64' };
            const PATTERNS = [ // Using an array MIGHT allow slight optimization if order matters
                { K:'ELF',     L:"ELF Binario",         B:[0x7F, 0x45, 0x4C, 0x46], E:true }, // Check Arch
                { K:'DEX',     L:"Archivo DEX",         B:[0x64, 0x65, 0x78, 0x0A] },         // Check start
                { K:'ARSC',    L:"Recursos (ARSC)",     B:[0x02, 0x00, 0x0C, 0x00] },         // Check start
                { K:'AXML',    L:"XML Binario",         B:[0x03, 0x00, 0x08, 0x00] },         // Check start
                { K:'LIB64',   L:"Librería ARM64",      P:/lib\/arm64-v8a\//i },             // Path check
                { K:'LIB7A',   L:"Librería ARMv7",      P:/lib\/armeabi-v7a\//i },           // Path check
                { K:'PNG',     L:"Imagen PNG",          B:[0x89, 0x50, 0x4E, 0x47] },         // Check start
                { K:'JPEG',    L:"Imagen JPEG",         B:[0xFF, 0xD8, 0xFF] },               // Check start
                { K:'WEBP',    L:"Imagen WEBP",         B:[0x52, 0x49, 0x46, 0x46] },         // Check start (RIFF)
                { K:'SQLITE',  L:"Base de Datos SQLite",B:[0x53, 0x51, 0x4C, 0x69] },         // Check start ("SQLi")
                { K:'ZIP',     L:"Cabecera ZIP",        B:[0x50, 0x4B, 0x03, 0x04] },         // Check start
                { K:'FLUTTER', L:"Assets Flutter",      P:/flutter_assets/i },             // Path check
                { K:'REACT',   L:"Bundle React Native", P:/index\.android\.bundle$/i },   // Path check
            ];

            // --- State ---
            let currentFile = null;
            let isWorking = false;
            let analysisId = 0; // To cancel stale operations

            // --- UI Functions ---
            function showMsg(msg, isError = false) {
                if (!D.err || !D.prog || !D.foot) return; // Safety check
                if (isError) {
                    D.err.textContent = msg; D.err.style.display = 'block';
                    console.error("APK Analyzer Error:", msg); D.foot.textContent = 'Error en análisis.';
                } else {
                    D.prog.textContent = msg; D.err.style.display = 'none'; // Hide error message if showing progress
                }
            }

            function setWorking(state, msg = '') {
                 if (!D.loader || !D.analyzeBtn || !D.cleanBtn || !D.fileIn || !D.inArea || !D.resArea || !D.contArea) {
                     console.error("setWorking: Cannot find essential DOM elements."); return; // Prevent errors if DOM isn't ready
                 }
                isWorking = state;
                D.loader.classList.toggle('visible', state);
                D.inArea.style.opacity = state ? '0.5' : '1';
                D.resArea.classList.remove('visible'); // Hide results while working
                D.contArea.classList.remove('allow-scroll'); // Disable scroll while loading/no results

                // Correctly enable/disable controls
                D.analyzeBtn.disabled = state;
                D.cleanBtn.disabled = state;
                D.fileIn.disabled = state; // Disable hidden file input too
                // Also disable the label visually acting as a button
                const labelBtn = D.inArea.querySelector('label[role="button"]');
                if (labelBtn) { labelBtn.style.pointerEvents = state ? 'none' : 'auto'; labelBtn.style.opacity = state ? '0.6' : '1'; }


                D.analyzeBtn.classList.toggle('active', state); // Visual feedback for analyze button

                if (state) {
                    D.resCont.innerHTML = ''; // Clear previous results display
                    D.foot.textContent = '';    // Clear footer status
                    showMsg(msg || 'Procesando...'); // Show initial message
                } else {
                    showMsg(''); // Clear progress message when done
                }
            }

            function resetStateAndUI() {
                analysisId++; // Increment to invalidate any ongoing async operations
                currentFile = null;
                if(D.fileIn) D.fileIn.value = ''; // Clear the actual file input
                if(D.fName) D.fName.textContent = 'Ningún archivo seleccionado';
                if(D.foot) D.foot.textContent = '';
                if(D.err) { D.err.style.display = 'none'; D.err.textContent = ''; }
                 if(D.resCont) D.resCont.innerHTML = `<div class="results-placeholder" id="resultsPlaceholder"><i class="fas fa-atom"></i><span>Esperando archivo APK...</span></div>`; // Reset placeholder
                 if(D.resArea) D.resArea.classList.remove('visible');
                 if(D.contArea) D.contArea.classList.remove('allow-scroll');
                setWorking(false); // Ensure UI is fully reset and enabled
            }

            // --- Core Analysis Logic ---
            function findMatches(buffer, name) {
                const findings = [];
                if (!name) return findings; // Need a filename for path checks
                let fileFindings = new Set(); // Track found pattern keys for THIS file

                for (const p of PATTERNS) {
                    if (fileFindings.has(p.K)) continue; // Already found this type

                    let match = false; let arch = null; let label = p.L;

                    // 1. Check Path Regex first if it exists
                    if (p.P && p.P.test(name)) {
                        match = true;
                    // 2. Check Bytes if Path didn't match (or pattern has no Path) AND Bytes exist AND buffer is available/long enough
                    } else if (p.B && buffer && buffer.byteLength >= p.B.length) {
                        const view = new Uint8Array(buffer); // Create view only if needed
                        let bytesOk = true;
                        for (let i = 0; i < p.B.length; i++) {
                            if (view[i] !== p.B[i]) { bytesOk = false; break; }
                        }
                        if (bytesOk) match = true;
                    }

                    // 3. If matched, process and add
                    if (match) {
                        if (p.E && buffer && buffer.byteLength >= 20) { // ELF Arch Check (requires buffer)
                           try {
                               const dataView = new DataView(buffer); // Create DataView only if needed
                               const machine = dataView.getUint16(18, dataView.getUint8(5) === 1); // Read e_machine respecting endianness
                               arch = ELF_ARCH[machine] || `Arch:0x${machine.toString(16).toUpperCase()}`;
                               label = `ELF (${arch})`; // Update label with arch info
                           } catch (e) { arch = "Arch Err"; console.warn(`ELF Arch read error in ${name}: ${e}`);}
                        }
                        // Add finding - simplified structure
                        findings.push({ L: label, F: name, A: arch });
                        fileFindings.add(p.K); // Mark as found for this file
                    }
                }
                return findings;
            }

            // --- Result Rendering ---
             async function renderResults(items, time, count, id) {
                 if (id !== analysisId || !D.resCont || !D.resArea || !D.contArea || !D.foot) return; // Check validity and DOM elements

                 D.resCont.innerHTML = ''; // Clear container

                 if (!items || items.length === 0) {
                     D.resCont.innerHTML = `<div class="no-findings"><i class="fas fa-ghost fa-lg"></i> No se encontraron elementos relevantes.</div>`;
                 } else {
                     showMsg(`Agrupando ${items.length} hallazgos...`);
                     await new Promise(r => setTimeout(r, 5)); // Minimal pause for UI update

                     const grouped = items.reduce((acc, i) => { (acc[i.L] = acc[i.L] || []).push(i); return acc; }, {});
                     const sortedLabels = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

                     showMsg(`Renderizando...`); await new Promise(r => setTimeout(r, 5));

                     let sectionsHTML = ''; // Build HTML string for performance
                     let renderCount = 0;

                     for (const label of sortedLabels) {
                         if (id !== analysisId) return; // Check cancellation mid-render

                         const sectionItems = grouped[label].sort((a, b) => a.F.localeCompare(b.F));
                         let listItemsHTML = '';

                         for(const item of sectionItems) {
                             const archSpan = item.A ? `<span class="finding-arch">${item.A}</span>` : '';
                             // Sanitize filename for display using textContent trick
                             const tempEl = document.createElement('span'); tempEl.textContent = item.F;
                             const safeFilenameHTML = tempEl.innerHTML;
                             listItemsHTML += `<li><span class="finding-location">${safeFilenameHTML}</span><span class="finding-offset">${archSpan || '(Detectado)'}</span></li>`;
                             renderCount++;
                         }

                         // Escape label for data-attribute, basic escaping ' -> ' " -> "
                         const safeLabelAttr = label.replace(/'/g, "'").replace(/"/g, """);

                         sectionsHTML += `
                             <div class="findings-section">
                                 <div class="section-header">
                                     <h3>${label} <span class="count">${sectionItems.length}</span></h3>
                                     <button class="copy-section-btn" data-label="${safeLabelAttr}"><i class="far fa-copy"></i> Copiar</button>
                                 </div>
                                 <ul>${listItemsHTML}</ul>
                             </div>`;

                         // Yield occasionally if rendering many sections
                         if (renderCount > RENDER_BATCH && renderCount % RENDER_BATCH < MAX_CONCURRENT) { // Yield roughly every batch
                              showMsg(`Renderizando: ${renderCount}/${items.length}`);
                              await new Promise(r => setTimeout(r, 0)); // Yield (0ms)
                         }
                     }
                     D.resCont.innerHTML = sectionsHTML; // Inject final HTML

                      // Add copy listeners AFTER HTML is in the DOM
                     D.resCont.querySelectorAll('.copy-section-btn').forEach(btn => {
                         const lbl = btn.dataset.label; // Read back the possibly escaped label
                         btn.onclick = (e) => copyToClipboard(e.currentTarget, lbl, grouped[lbl]);
                     });

                     D.resArea.classList.add('visible'); // Show results area
                     D.contArea.classList.add('allow-scroll'); // Enable scroll
                 }

                 D.foot.textContent = `Análisis en ${time}s (${count} archivos). ${items.length} hallazgos.`;
                 setWorking(false); // Finish working state
             }

             // --- Clipboard Function ---
             async function copyToClipboard(btn, label, items) {
                 if (!items || items.length === 0 || !navigator.clipboard) return;
                 // Format text for clipboard
                 const textToCopy = `--- ${label} (${items.length}) ---\n` +
                                    items.map(i => `${i.F}${i.A ? ` [${i.A}]` : ''}`).join('\n');
                 try {
                     await navigator.clipboard.writeText(textToCopy);
                     // Visual Feedback
                     const originalHTML = btn.innerHTML;
                     btn.innerHTML = `<i class="fas fa-check"></i> Copiado`;
                     btn.classList.add('copied'); btn.disabled = true;
                     setTimeout(() => { btn.innerHTML = originalHTML; btn.classList.remove('copied'); btn.disabled = false; }, COPY_DELAY);
                 } catch (err) {
                     console.error("Error al copiar:", err);
                     const originalHTML = btn.innerHTML;
                     btn.innerHTML = `<i class="fas fa-times"></i> Error`; btn.disabled = true; // Keep disabled briefly on error
                     setTimeout(() => { btn.innerHTML = originalHTML; btn.disabled = false; }, 2000);
                 }
             }

            // --- Main Analysis Workflow ---
            async function runAnalysis() {
                if (!currentFile || isWorking) return; // Prevent concurrent runs or run without file
                const localId = ++analysisId;         // Unique ID for this run
                setWorking(true, `Abriendo ${currentFile.name}...`); // Set loading state
                const startTime = performance.now();
                let allFindings = []; let fileCount = 0; let processedCount = 0;

                try {
                    const zip = await JSZip.loadAsync(currentFile);
                    // Filter out directories and potentially invalid entries robustly
                    const filesToScan = Object.values(zip.files).filter(f => f && !f.dir && typeof f.name === 'string' && f.name.length > 0 && !f.name.endsWith('/'));
                    fileCount = filesToScan.length;
                    if (fileCount === 0) throw new Error("El APK no contiene archivos válidos.");

                    showMsg(`Analizando ${fileCount} archivos...`);
                    await new Promise(r => setTimeout(r, 10)); // Brief UI update pause

                    // Process files in concurrent chunks
                    for (let i = 0; i < fileCount; i += MAX_CONCURRENT) {
                        if (localId !== analysisId) break; // Check if analysis was cancelled

                        const chunk = filesToScan.slice(i, i + MAX_CONCURRENT);
                        const chunkPromises = chunk.map(async (file) => {
                            if (localId !== analysisId) return; // Double check cancellation before async op
                            let buffer = null;
                             try {
                                // Determine if buffer is needed ONLY for patterns with Bytes or ELF flag
                                const needsBuffer = PATTERNS.some(p => (p.B || p.E) && (!p.P || p.P.test(file.name)));
                                if (needsBuffer) {
                                     buffer = await file.async("arraybuffer"); // Read only if needed
                                }
                                if (localId === analysisId) { // Check cancellation *after* async read
                                    allFindings.push(...findMatches(buffer, file.name));
                                }
                             } catch (e) {
                                 console.warn(`Error procesando ${file.name}: ${e.message}`);
                                 // Optional: Add to findings as an error entry?
                                 // findings.push({ L: "Error de Lectura", F: file.name, A: e.message });
                             }
                             processedCount++;
                             // Update progress indicator periodically (less frequent for performance)
                             if (localId === analysisId && processedCount % 50 === 0) {
                                 // Use rAF for smoother UI update, avoids layout thrashing
                                 requestAnimationFrame(() => showMsg(`Analizando: ${processedCount}/${fileCount} (${Math.round(processedCount * 100 / fileCount)}%)`));
                             }
                        }); // End of chunkPromises map

                        await Promise.all(chunkPromises); // Wait for the current chunk to finish
                        await new Promise(r => setTimeout(r, 0)); // Yield to the browser between chunks
                    } // End of chunk processing loop

                    // Final step: Render results if this run wasn't cancelled
                    if (localId === analysisId) {
                        const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                        showMsg('Análisis completo. Renderizando...');
                        await renderResults(allFindings, duration, fileCount, localId);
                         // setWorking(false) is called inside renderResults
                    }

                } catch (err) {
                    console.error("Error Crítico en Análisis:", err);
                     if (localId === analysisId) { // Show error only if it belongs to this run
                         showMsg(`Error Crítico: ${err.message}`, true);
                         setWorking(false); // Ensure UI is reset on failure
                     }
                }
            }

            // --- Public Initialization and Interface ---
            function init() {
                // Safety check for essential DOM elements
                 if (!D.fileIn || !D.analyzeBtn || !D.cleanBtn || !D.fName || !D.resCont) {
                     console.error("Error fatal: Faltan elementos DOM esenciales para el analizador.");
                     // Disable controls if setup failed
                     if (D.analyzeBtn) D.analyzeBtn.disabled = true;
                     if (D.cleanBtn) D.cleanBtn.disabled = true;
                     return;
                 }

                // File Input Listener
                D.fileIn.addEventListener('change', (e) => {
                    resetStateAndUI(); // Clear everything from previous file/state
                    const file = e.target.files?.[0];
                    if (file && file.name.toLowerCase().endsWith('.apk') && file.size > MIN_SIZE) {
                        currentFile = file;
                        // Safely display filename using textContent
                        const tempSpan = document.createElement('span');
                        tempSpan.textContent = file.name;
                        D.fName.innerHTML = tempSpan.innerHTML; // Use innerHTML to display sanitized content

                        runAnalysis(); // Start analysis automatically after valid selection
                    } else if (file) {
                        // Handle invalid file selection
                        showMsg(`Selecciona un archivo .apk válido (mínimo ${MIN_SIZE/1024}KB).`, true);
                        currentFile = null;
                        D.fName.textContent = 'Archivo inválido';
                        D.fileIn.value = ''; // Clear the invalid selection from the input
                    } else {
                        // No file selected (e.g., user cancelled dialog)
                        resetStateAndUI();
                    }
                });

                // Set initial clean state
                resetStateAndUI();
            }

            // --- Functions Exposed for Panel Buttons ---
            function triggerAnalysis() {
                if (!currentFile) {
                    D.fileIn.click(); // Trigger file selection dialog
                } else {
                    runAnalysis(); // Start analysis with the current file
                }
            }

            function resetPublicInterface() {
                resetStateAndUI(); // Call the internal reset function
            }

            // Expose public methods
            return {
                init: init,
                trigger: triggerAnalysis,
                reset: resetPublicInterface
            };

        })(); // Execute the IIFE to create the analyzer module

        // <<<--- SCRIPT 3: INICIALIZACIÓN Y CONEXIÓN FINAL --->>>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Panel UI Controller (Handles animations, visibility)
            panelController.init();

            // 2. Initialize APK Analyzer Logic (Handles file processing, results)
            apkAnalyzer.init();

            // 3. Connect Panel Buttons to Analyzer Actions (and Panel Actions)
            const analyzeBtn = document.getElementById('analyzeTriggerButton');
            const cleanBtn = document.getElementById('boton-limpiar');
            const youtubeBtn = document.querySelector('.youtube-link'); // External link example

            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', () => {
                    panelController.ocultarPanel(); // Close the panel
                    // Use a small delay if needed, otherwise call directly
                    // setTimeout(() => apkAnalyzer.trigger(), 100);
                    apkAnalyzer.trigger();       // Tell analyzer to start or prompt for file
                });
            }

            if (cleanBtn) {
                cleanBtn.addEventListener('click', () => {
                    panelController.ocultarPanel(); // Close the panel
                    // setTimeout(() => apkAnalyzer.reset(), 100);
                     apkAnalyzer.reset();         // Tell analyzer to reset its state and UI
                });
            }

            // Handle external links: just close the panel
            if (youtubeBtn) {
                youtubeBtn.addEventListener('click', () => {
                    panelController.ocultarPanel();
                    // No action needed for the analyzer on external link clicks
                });
            }

            console.log("Panel y Analizador inicializados."); // Confirmation log

        }); // End DOMContentLoaded
    </script>

</body>
</html>
